# 基于 Bhattacharyya distance 的室内定位方法研究

## 引言
随着 LBS 的迅猛发展，单纯的室外定位技术已经满足不了 LBS 在室内的定位需求。这就使得室内定位的技术被广泛的关注，引起各大研究机构和大学的大力研究。各种类型的定位技术也就慢慢的成熟起来。在前面的章节中我们提到，定位方法本质上可以分为两类，一种是基于确定性的定位方法，另外一种是基于概率性的定位方法。定位方法的种类繁多，但是总的来说可以分为这两类，这两类方法的实现方式也是不太一样的。一类是基于采集到的信号的均值来计算，另一类是基于信号的概率分布来计算的。但其实无论是基于确定性的方法还是基于概率性的方法，本质上都是在计算一个相似度。就是待计算的样本与样本库中数据的相似度，我们要做的就是计算出相似度最高的那条数据，然后将这条数据作为我们的定位结果。但是在计算的时候，相似度需要有一个度量值，而这个相似度一般都是使用距离来表示。确定性的定位方法和概率性的定位方法都可以使用距离来表示计算所得的相似度。

### 欧式距离
欧式距离也称欧几里得距离，是由古希腊数学家欧几里德发明的。这是一个通常采用的距离定义，它是在n维空间中两个点之间的真实距离。欧式距离可以看作是信号的相似程度，距离越近，相似度就越高。标准化欧式距离是针对欧式距离的缺点而做出的优化方案。［公式］


### 曼哈顿距离
曼哈顿距离简单来说就是在欧几里得空间的固定直角坐标系上两点所形成的线段对称轴产生的投影的距离的总和。在二维平面上，坐标 (x1,y1)的点 P1 与坐标 (x2,y2)的点 P2 的曼哈顿距离为: |x1 - x2|+|y1 - y2|,曼哈顿距离依赖坐标系统的转度，而非系统坐标在坐标系统上的映射和平移。［公式］

### 巴氏距离
巴氏距离这个名称是为了纪念20世纪30年代曾在印度统计研究所工作的统计学家A.Bhattacharyya。巴氏距离这个概念就是以他的姓名命名。在统计学中，巴氏距离测量两个离散或连续概率分布的相似性。它可以用来衡量两个统计样品的相似度，这个相似度可以使用巴氏系数来衡量，巴氏距离可以使用两个样品的巴氏系数计算出来。［公式］
本文的主要研究的算法就是基于巴氏距离的。

## 巴氏定位理论

### 位置指纹的表示
在基于 WLAN 位置指纹定位技术的研究中，作为指纹的重要特征的 RSS 是一个很容易受到影响而导致信号值变化的特征信息。同一个 AP 点发出的信号的测量值随着不同位置而有着不同的值，即使是处在同一个位置上，信号指也会有不同程度的波动。
对于不同的定位算法，对着指纹有不同的需求。而本文研究的巴氏定位算法，则是需要 AP 点信号强度的概率分布，指纹使用 F(pi)表示。
［指纹样式］
其中， mac 表示 AP 点的物理地址，每个 AP 点的物理地址都是唯一的，所以可以使用物理地址来指代 AP。 rss 表示 AP 点发出的信号强度值，pi 表示该 rss 强度在 AP 中（同一位置）发出的概率。那么，这样的一组数据，就是计算所需要的指纹数据。

### 巴氏定位原理及算法实现
以下先声明一些下文会用到的词:
O: 采集范围内 AP 点的集合。
{sm} m 属于O:一个样本中指纹数据的集合。
L: 一个样本内采集到的信号数。
m: 表示 AP 的物理地址。
Nm(s):表示 AP m中 信号强度为 s 的数量。 

在基于 WLAN 位置指纹的技术的实现中，可以分为两个阶段，一个是离线采集阶段，一个是在先定位阶段。在离线阶段，我们需要对指纹数据进行采集。在巴氏算法的研究中，指纹是所有样本数据中每一个 AP 点的信号强度值的概率分布。一个样本数据就是由 O 中每一个 AP 发出的信号的集合。那么信号的概率分布就是: Pm(s) = Nm(s)/L

下图就展示了一个指纹样本的概率分布：图［一个样本数据的概率分布图］。

#### 离线阶段
离线阶段就是指纹采集的阶段，我们需要采集大量的指纹数据。我们采取的采集策略是在一个采集点采集八个方向，在每个方向上采集20次，也就是每个参考点的采集次数是160次。在上文介绍了离线指纹的计算方法之后，我们就可以得到一个概率指纹库，用一下的方式来表示：{Plm(s)}l属于{1...N}，N 是参考点的数量。在这些计算完成之后，那么我们的离线指纹库的创建就完成了。

#### 在线阶段
在线阶段就是为了通过在线采集 RSS 信息，通过服务器上指纹库的匹配从而找出用户的位置所在。在在线定位阶段，我们也会通过移动端采集一系列的样本数据，然后计算出这些样本数据的概率分布 Qm(s)，这些样本数据将会和离线库中的数据进行对比。
对于每一个线下采集的参考点 l，每次匹配时我们取信号平均强度排在前 q （q>=1）的 q 个AP点参与匹配计算，表示为Oql。在这些数据准备完成之后，我们就可以计算出 巴氏系数 Bm,l。公式［巴氏系数计算方法］
如果 AP m是 Oql 的一部分，但是没有在用户的采集到的数据中，则将 Bm,l的值置为0.
通过这 q 个信号较强的 AP 点计算出来的巴氏系数就可以用于计算用户参考点的位置与参考点 l 之间啊巴氏距离。具体计算方法如下所示：公式［巴氏距离的计算方法］
距离越小，重合度也就越高，也就越说明用户位置与参考点的距离越短。也就可以根据这些距离来判断出用户的位置所在。


## 基于巴氏距离的室内定位的原型实现
在介绍完上述的定位方法之后，我将通过设计一个原型系统来对上述的理论进行验证。通过实验的结果来说明该定位方法的可行性。该原型系统是基于 Android 和 J2EE 平台实现的。Android 移动端作为信号采集和在线定位的工具，J2EE 和 Mysql 作为服务器端的开发平台。开发工具使用的是 Eclipse。在设计整个系统的过程中，有两种系统架构可供选择。分别是基于客户端的系统结构和基于服务器端的系统架构。也可以称之为胖客户端和瘦客户端，两种的实现有很大的差别。在胖客户端的，原型系统被部署在客户端。当用户需要定位时，移动端开始采集信号值，然后直接在移动端进行匹配计算并给出计算出的位置，这样一来，用户端的计算量就会大大的增大，就会带来手机功耗过大的问题。下图是基于胖客户端设计的原型系统架构图：图［胖客户端系统原型系统架构图］

在基于与服务器的系统架构上，也就是瘦客户端上。定位的过程不再是只在客户端完成，而是将定位的整个过程放在客户端和服务器上两个地方。客户端主要完成信息采集和定位结果的展示，这样一来，就可以大大的减少客户端的功耗。本文所采用的方式就是瘦客户端的模式。下面是基于瘦客户端设计的原型
系统架构图。图［瘦客户端系统原型架构图］
### 客户端设计
客户端是在 Android 平台上实现的，如今 Android 系统已经是全球最大的移动端平台。 Android 操作系统为开发者提供丰富的 API。所以在实现客户端功能的过程中，可以借助 Android 的 API 来完成客户端的功能。在该原型系统中，客户端需要完成的功能有：

- 线下采集信号值，将信号值简单处理后发送到服务器，完成指纹库的建立。

- 在线定位，获取当前位置的信号值， 发送到服务器端完成匹配计算，并获得定位结果。


具体的流程图如下：

### 服务器端设计
在该原型系统中，主要的工作量都是在服务器端。服务器端的实现是基于J2EE这个平台。J2EE 是一个很优秀的企业级开发平台。可以满足我们开发这个原型系统的要求。服务器端的设计可以分为建库模块，在线定位模块，线下聚类模块。

- 建库模块接收客户端发来的信号强度集合，并对这些数据进行线下概率分布，最终建成指纹库。

- 在线定位模块是原型系统的核心功能，接收在线定位发送过来信号值，将这些信号值处理成与指纹数据一样的格式之后进行匹配计算，并且计算出位置结果。

- 线下聚类模块会对指纹库进行优化，较少匹配计算的数量量，有利于减轻服务器的压力以及提高程序的响应能力。

三个模块的具体流程图如下：


一个好的系统需要一个设计良好的数据库的支持。一个设计良好的数据库可以较少数据的冗余，提升数据库的查询效率。在该系统中，数据库的设计如下：


## 本章小结
在本章中，我们从介绍巴氏距离开始，详细介绍了巴氏算法的整个体系。巴氏算法需要基于概率分布的指纹数据。巴氏算法通过计算两个样本之间的巴氏系数来确定两个样本之间的相似度。最后通过相似度来计算出两个样本之间的巴氏距离。并且介绍了如何将巴氏算法应用到定位系统中。另外还详细说明了整个原型系统的设计，Android 移动端可以通过原生 API 的支持，很方便的完成客户端的开发。而服务器端设计的复杂度就要高很多。服务器通过模块设计，将整个系统划分成多个模块。除了建库模块和匹配模块，还有一个聚类模块，聚类模块是为了提高系统的运行性能。详细会在下一章中提到。